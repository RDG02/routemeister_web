{% extends 'planning/base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="wizard-container">
    <!-- Progress Bar -->
    <div class="wizard-progress">
        <div class="progress-step active">
            <div class="step-number">1</div>
            <div class="step-label">Upload</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step">
            <div class="step-number">2</div>
            <div class="step-label">Preview & Validatie</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step">
            <div class="step-number">3</div>
            <div class="step-label">Auto-Assignment & Routes</div>
        </div>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <h1>📁 Upload CSV/SLK Bestand</h1>
        <p class="section-description">
            Upload je bestand met patiëntgegevens.
            Na upload ga je automatisch door naar het preview scherm.
        </p>

        <!-- File Upload Area -->
        <div class="upload-area" id="uploadArea">
            <div class="upload-content">
                <div class="upload-icon">📁</div>
                <h3>Sleep je bestand hierheen</h3>
                <p>of klik om een bestand te kiezen</p>
                <p class="file-types">Ondersteunde formaten: .csv, .slk</p>
                
                <input type="file" id="fileInput" accept=".csv,.slk" style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                    <span class="btn-icon">📂</span>
                    Bestand Kiezen
                </button>
            </div>
        </div>

        <!-- Upload Progress -->
        <div class="upload-progress" id="uploadProgress" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Uploaden...</div>
        </div>

        <!-- Upload Results -->
        <div class="upload-results" id="uploadResults" style="display: none;">
            <div class="result-card success">
                <div class="result-icon">✅</div>
                <div class="result-content">
                    <h3>Upload Succesvol!</h3>
                    <div class="result-details" id="resultDetails"></div>
                </div>
            </div>
            
            <!-- Parser Details -->
            <div class="parser-details" id="parserDetails" style="display: none;">
                <h4>🔧 Parser Instellingen</h4>
                <div class="parser-info" id="parserInfo"></div>
            </div>
            
            <!-- Data Preview -->
            <div class="data-preview" id="dataPreview" style="display: none;">
                <h4>📋 Data Preview</h4>
                <div class="preview-table-container">
                    <table class="preview-table" id="previewTable">
                        <thead>
                            <tr>
                                <th>Rij</th>
                                <th>Type</th>
                                <th>Data</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="previewTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="continueToNextStep()">
                    <span class="btn-icon">🚀</span>
                    Start Auto-Assignment
                </button>
            </div>
        </div>

        <!-- Error Display -->
        <div class="upload-error" id="uploadError" style="display: none;">
            <div class="error-card">
                <div class="error-icon">❌</div>
                <div class="error-content">
                    <h3>Upload Fout</h3>
                    <p id="errorMessage"></p>
                    <button class="btn btn-secondary" onclick="retryUpload()">
                        <span class="btn-icon">🔄</span>
                        Opnieuw Proberen
                    </button>
                </div>
            </div>
        </div>
    </div>


</div>

<script>
// File upload handling
document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const uploadProgress = document.getElementById('uploadProgress');
    const uploadResults = document.getElementById('uploadResults');
    const uploadError = document.getElementById('uploadError');
    
    // Drag and drop functionality
    uploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
    });
    
    uploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileUpload(files[0]);
        }
    });
    
    // File input change
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileUpload(e.target.files[0]);
        }
    });
    
    // Click to upload - alleen als er geen file is geselecteerd
    uploadArea.addEventListener('click', function(e) {
        // Voorkom dubbele clicks
        if (e.target.tagName !== 'BUTTON') {
            fileInput.click();
        }
    });
});

function handleFileUpload(file) {
    // Validate file type
    const allowedTypes = ['.csv', '.slk'];
    const fileExtension = '.' + file.name.split('.').pop().toLowerCase();
    
    if (!allowedTypes.includes(fileExtension)) {
        showError('Alleen CSV en SLK bestanden zijn toegestaan.');
        return;
    }
    
    // Validate file size (max 10MB)
    if (file.size > 10 * 1024 * 1024) {
        showError('Bestand is te groot. Maximum grootte is 10MB.');
        return;
    }
    
    // Show progress
    showProgress();
    
    // Create FormData
    const formData = new FormData();
    formData.append('file', file);
    
    // Upload file
    fetch('{% url "api_wizard_upload" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showResults(data.data);
        } else {
            showError(data.error || 'Onbekende fout opgetreden');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showError('Upload fout: ' + error.message);
    });
}

function showProgress() {
    document.getElementById('uploadArea').style.display = 'none';
    document.getElementById('uploadProgress').style.display = 'block';
    document.getElementById('uploadResults').style.display = 'none';
    document.getElementById('uploadError').style.display = 'none';
    
    // Simulate progress
    let progress = 0;
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    
    const interval = setInterval(() => {
        progress += 10;
        progressFill.style.width = progress + '%';
        
        if (progress <= 30) {
            progressText.textContent = 'Bestand uploaden...';
        } else if (progress <= 60) {
            progressText.textContent = 'Formaat detecteren...';
        } else if (progress <= 90) {
            progressText.textContent = 'Data valideren...';
        } else {
            progressText.textContent = 'Voltooid! Doorgaan naar preview...';
            clearInterval(interval);
        }
    }, 200);
}

function showResults(data) {
    document.getElementById('uploadProgress').style.display = 'none';
    
    // Toon kort een succes bericht
    const resultDetails = document.getElementById('resultDetails');
    resultDetails.innerHTML = `
        <div class="detail-item">
            <strong>Bestand:</strong> ${data.filename}
        </div>
        <div class="detail-item">
            <strong>Patiënten:</strong> ${data.patient_count}
        </div>
        <div class="detail-item">
            <strong>Formaat:</strong> ${data.detection_result.detected_format}
        </div>
        <div class="detail-item">
            <strong>Confidence:</strong> ${data.detection_result.confidence}%
        </div>
        <div class="detail-item">
            <strong>Geldige Rijen:</strong> ${data.validation_result.valid_rows || 0}
        </div>
    `;
    
    // Toon upload results kort
    document.getElementById('uploadResults').style.display = 'block';
    
    // Ga automatisch door naar de volgende stap na 1.5 seconde
    setTimeout(() => {
        continueToNextStep();
    }, 1500);
}

function showError(message) {
    document.getElementById('uploadProgress').style.display = 'none';
    document.getElementById('uploadError').style.display = 'block';
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('errorMessage').textContent = message;
    
    // Auto-hide error after 5 seconds
    setTimeout(() => {
        document.getElementById('uploadError').style.display = 'none';
    }, 5000);
}

function retryUpload() {
    document.getElementById('uploadError').style.display = 'none';
    document.getElementById('uploadArea').style.display = 'block';
    document.getElementById('fileInput').value = '';
}

function continueToNextStep() {
    // Disable button to prevent double clicks
    const nextBtn = document.querySelector('.btn-primary[onclick="continueToNextStep()"]');
    nextBtn.disabled = true;
    nextBtn.innerHTML = '<span class="btn-icon">⏳</span> Laden...';
    
    // Save upload data to session and then redirect to assignment
    fetch('{% url "api_wizard_save_upload_data" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            action: 'save_upload_data'
        })
    })
    .then(response => response.json())
            .then(data => {
            if (data.success) {
                // Redirect to preview step
                window.location.href = '{% url "planning_wizard_preview" %}';
            } else {
                // Re-enable button on error
                nextBtn.disabled = false;
                nextBtn.innerHTML = '<span class="btn-icon">👁️</span> Bekijk Preview';
                showError('Fout bij opslaan: ' + (data.error || 'Onbekende fout'));
            }
        })
    .catch(error => {
        console.error('Error saving upload data:', error);
        // Re-enable button on error
        nextBtn.disabled = false;
        nextBtn.innerHTML = '<span class="btn-icon">👁️</span> Bekijk Preview';
        showError('Fout bij opslaan: ' + error.message);
    });
}

function showParserDetails(detectionResult, parserConfig) {
    const parserDetails = document.getElementById('parserDetails');
    const parserInfo = document.getElementById('parserInfo');
    
    if (detectionResult.config_id && parserConfig) {
        // Admin configuratie gebruikt
        parserInfo.innerHTML = `
            <div class="parser-config">
                <div class="config-item">
                    <strong>Configuratie ID:</strong> ${detectionResult.config_id}
                </div>
                <div class="config-item">
                    <strong>Configuratie Naam:</strong> ${parserConfig.naam || 'Onbekend'}
                </div>
                ${parserConfig.beschrijving ? `
                    <div class="config-item">
                        <strong>Beschrijving:</strong> ${parserConfig.beschrijving}
                    </div>
                ` : ''}
                <div class="config-item">
                    <strong>Gedetecteerd Formaat:</strong> ${detectionResult.detected_format}
                </div>
                <div class="config-item">
                    <strong>Confidence Score:</strong> ${detectionResult.confidence}%
                </div>
                <div class="config-item">
                    <strong>Kolom Mapping:</strong>
                    <div class="mapping-details">
                        ${Object.entries(detectionResult.mappings).map(([field, index]) => 
                            `<span class="mapping-item">${field}: kolom ${index}</span>`
                        ).join('')}
                    </div>
                </div>
                ${parserConfig.bestandsnaam_patroon ? `
                    <div class="config-item">
                        <strong>Bestandsnaam Patroon:</strong> 
                        <span class="config-value">${parserConfig.bestandsnaam_patroon}</span>
                    </div>
                ` : ''}
                ${parserConfig.header_keywords ? `
                    <div class="config-item">
                        <strong>Header Keywords:</strong>
                        <div class="keywords-list">
                            ${parserConfig.header_keywords.split(',').map(keyword => 
                                `<span class="keyword-item">${keyword.trim()}</span>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
                ${parserConfig.datum_formaten ? `
                    <div class="config-item">
                        <strong>Datum Formaten:</strong>
                        <div class="formats-list">
                            ${parserConfig.datum_formaten.split(',').map(format => 
                                `<span class="format-item">${format.trim()}</span>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
                ${parserConfig.tijd_formaten ? `
                    <div class="config-item">
                        <strong>Tijd Formaten:</strong>
                        <div class="formats-list">
                            ${parserConfig.tijd_formaten.split(',').map(format => 
                                `<span class="format-item">${format.trim()}</span>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
                ${detectionResult.warnings.length > 0 ? `
                    <div class="config-item">
                        <strong>Waarschuwingen:</strong>
                        <div class="warnings-list">
                            ${detectionResult.warnings.map(warning => `<span class="warning-item">⚠️ ${warning}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    } else {
        // Fallback detectie gebruikt
        parserInfo.innerHTML = `
            <div class="parser-config">
                <div class="config-item">
                    <strong>Detectie Methode:</strong> Fallback Auto-detectie
                </div>
                <div class="config-item">
                    <strong>Gedetecteerd Formaat:</strong> ${detectionResult.detected_format}
                </div>
                <div class="config-item">
                    <strong>Confidence Score:</strong> ${detectionResult.confidence}%
                </div>
                ${detectionResult.warnings.length > 0 ? `
                    <div class="config-item">
                        <strong>Waarschuwingen:</strong>
                        <div class="warnings-list">
                            ${detectionResult.warnings.map(warning => `<span class="warning-item">⚠️ ${warning}</span>`).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    parserDetails.style.display = 'block';
}

function showDataPreview(csvData) {
    const dataPreview = document.getElementById('dataPreview');
    const previewTableBody = document.getElementById('previewTableBody');
    
    if (!csvData || csvData.length === 0) {
        dataPreview.style.display = 'none';
        return;
    }
    
    // Toon eerste 10 rijen
    const previewRows = csvData.slice(0, 10);
    
    previewTableBody.innerHTML = '';
    
    previewRows.forEach((row, index) => {
        const tr = document.createElement('tr');
        const rowType = row.type || 'unknown';
        const rowData = row.data || [];
        
        // Bepaal status op basis van type en validatie
        let status = 'OK';
        let statusClass = 'status-ok';
        
        if (rowType === 'header') {
            status = 'Header';
            statusClass = 'status-header';
        } else if (rowType === 'data') {
            if (row.validation_errors && row.validation_errors.length > 0) {
                status = '❌ Fout';
                statusClass = 'status-error';
            } else if (row.validation_warnings && row.validation_warnings.length > 0) {
                status = '⚠️ Waarschuwing';
                statusClass = 'status-warning';
            } else {
                status = '✅ OK';
                statusClass = 'status-ok';
            }
        }
        
        tr.innerHTML = `
            <td>${index + 1}</td>
            <td>${rowType}</td>
            <td class="data-cell">
                <div class="data-preview-content">
                    ${rowData.slice(0, 5).map((cell, cellIndex) => 
                        `<span class="cell-item">${cellIndex}: ${cell || '-'}</span>`
                    ).join('')}
                    ${rowData.length > 5 ? `<span class="cell-more">... (+${rowData.length - 5} meer)</span>` : ''}
                </div>
            </td>
            <td><span class="status-badge ${statusClass}">${status}</span></td>
        `;
        
        previewTableBody.appendChild(tr);
    });
    
    dataPreview.style.display = 'block';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<style>
.wizard-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 2rem;
}

.wizard-progress {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 3rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 12px;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0.5;
    transition: opacity 0.3s;
}

.progress-step.active {
    opacity: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.progress-step.active .step-number {
    background: #F8CD46;
}

.progress-step.completed .step-number {
    background: #28a745;
}

.step-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: #6c757d;
}

.progress-line {
    width: 80px;
    height: 2px;
    background: #dee2e6;
    margin: 0 1rem;
}

.upload-section {
    text-align: center;
    margin-bottom: 3rem;
}

.upload-section h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: #2c3e50;
}

.section-description {
    font-size: 1.1rem;
    color: #6c757d;
    margin-bottom: 2rem;
}

.upload-area {
    border: 3px dashed #dee2e6;
    border-radius: 12px;
    padding: 3rem;
    margin-bottom: 2rem;
    cursor: pointer;
    transition: all 0.3s;
}

.upload-area:hover,
.upload-area.drag-over {
    border-color: #F8CD46;
    background: #fffbf0;
}

.upload-content {
    text-align: center;
}

.upload-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.upload-content h3 {
    margin-bottom: 0.5rem;
    color: #2c3e50;
}

.upload-content p {
    color: #6c757d;
    margin-bottom: 1rem;
}

.file-types {
    font-size: 0.9rem;
    color: #6c757d;
    margin-bottom: 1.5rem;
}

.upload-progress {
    margin-bottom: 2rem;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 1rem;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #F8CD46, #f39c12);
    width: 0%;
    transition: width 0.3s;
}

.progress-text {
    color: #6c757d;
    font-weight: 500;
}

.upload-results {
    margin-bottom: 2rem;
}

.result-card {
    display: flex;
    align-items: center;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.result-icon {
    font-size: 2rem;
    margin-right: 1rem;
}

.result-content h3 {
    margin-bottom: 0.5rem;
    color: #155724;
}

.detail-item {
    margin-bottom: 0.25rem;
    color: #155724;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.upload-error {
    margin-bottom: 2rem;
}

.error-card {
    display: flex;
    align-items: center;
    background: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 12px;
    padding: 1.5rem;
}

.error-icon {
    font-size: 2rem;
    margin-right: 1rem;
}

.error-content h3 {
    margin-bottom: 0.5rem;
    color: #721c24;
}

.error-content p {
    color: #721c24;
}

/* Parser Details Styling */
.parser-details {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 1.5rem;
    margin: 1.5rem 0;
}

.parser-details h4 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-size: 1.2rem;
}

.parser-config {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.config-item {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.config-item strong {
    color: #495057;
    font-weight: 600;
}

.mapping-details {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-top: 0.25rem;
}

.mapping-item {
    background: #e9ecef;
    color: #495057;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-family: monospace;
}

.warnings-list {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    margin-top: 0.25rem;
}

.warning-item {
    color: #856404;
    background: #fff3cd;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.85rem;
}

.config-value {
    background: #e9ecef;
    color: #495057;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.85rem;
}

.keywords-list,
.formats-list {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-top: 0.25rem;
}

.keyword-item,
.format-item {
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-family: monospace;
}

/* Data Preview Styling */
.data-preview {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 1.5rem;
    margin: 1.5rem 0;
}

.data-preview h4 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-size: 1.2rem;
}

.preview-table-container {
    overflow-x: auto;
    border: 1px solid #dee2e6;
    border-radius: 8px;
}

.preview-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
}

.preview-table th,
.preview-table td {
    padding: 0.75rem;
    text-align: left;
    border-bottom: 1px solid #dee2e6;
}

.preview-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #495057;
}

.data-cell {
    max-width: 300px;
}

.data-preview-content {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.cell-item {
    background: #f8f9fa;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: monospace;
    font-size: 0.8rem;
    color: #495057;
}

.cell-more {
    color: #6c757d;
    font-style: italic;
    font-size: 0.8rem;
}

.status-badge {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
    text-align: center;
    display: inline-block;
    min-width: 80px;
}

.status-ok {
    background: #d4edda;
    color: #155724;
}

.status-error {
    background: #f8d7da;
    color: #721c24;
}

.status-warning {
    background: #fff3cd;
    color: #856404;
}

.status-header {
    background: #d1ecf1;
    color: #0c5460;
}



.btn {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: linear-gradient(135deg, #F8CD46, #f39c12);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(248, 205, 70, 0.3);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-icon {
    margin-right: 0.5rem;
}

@media (max-width: 768px) {
    .wizard-container {
        padding: 1rem;
    }
    
    .upload-section h1 {
        font-size: 2rem;
    }
    
    .upload-area {
        padding: 2rem 1rem;
    }
    
    .action-buttons {
        flex-direction: column;
    }
    

}
</style>
{% endblock %}
