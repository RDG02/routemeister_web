{% extends 'planning/base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="wizard-container">
    <!-- Progress Bar -->
    <div class="wizard-progress">
        <div class="progress-step">
            <div class="step-number">1</div>
            <div class="step-label">Upload & Preview</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step active">
            <div class="step-number">2</div>
            <div class="step-label">Toewijzing & Routes</div>
        </div>
    </div>

    <!-- Assignment Section -->
    <div class="assignment-section">
        <h1>🤖 Toewijzing & Route Generatie</h1>
        <p class="section-description">
            Auto-toewijzing van patiënten aan voertuigen en tijdblokken, met mogelijkheid voor handmatige correcties.
        </p>

        <!-- Auto Assignment Results -->
        <div class="assignment-results" id="assignmentResults" style="display: none;">
            <div class="result-card success">
                <div class="result-icon">✅</div>
                <div class="result-content">
                    <h3>Auto-toewijzing Voltooid!</h3>
                    <div class="result-details" id="assignmentDetails"></div>
                </div>
            </div>
        </div>

        <!-- Assignment Progress -->
        <div class="assignment-progress" id="assignmentProgress">
            <div class="progress-card">
                <div class="progress-icon">🤖</div>
                <div class="progress-content">
                    <h3>Auto-toewijzing Uitvoeren</h3>
                    <p>Patiënten worden automatisch toegewezen aan voertuigen en tijdblokken volgens de geconfigureerde constraints.</p>
                    
                    <div class="constraint-summary">
                        <h4>Actieve Constraints:</h4>
                        <ul id="constraintList">
                            <li>🔄 Laden...</li>
                        </ul>
                    </div>
                    
                    <button class="btn btn-primary" onclick="startAutoAssignment()">
                        <span class="btn-icon">🚀</span>
                        Start Auto-toewijzing
                    </button>
                </div>
            </div>
        </div>

        <!-- Manual Assignment Interface -->
        <div class="manual-assignment" id="manualAssignment" style="display: none;">
            <h3>🖱️ Handmatige Correcties</h3>
            <p>Sleep patiënten tussen voertuigen en tijdblokken om de toewijzing aan te passen.</p>
            
            <!-- View Toggle Buttons -->
            <div class="view-toggle">
                <button class="view-btn active" data-view="vehicles" onclick="switchView('vehicles')">
                    🚐 Voertuigen
                </button>
                <button class="view-btn" data-view="patients" onclick="switchView('patients')">
                    👥 Patiënten
                </button>
                <button class="view-btn" data-view="timeslots" onclick="switchView('timeslots')">
                    ⏰ Tijdblokken
                </button>
            </div>
            
            <!-- Drag & Drop Area -->
            <div class="drag-drop-area" id="dragDropArea">
                <div class="drag-drop-placeholder">
                    <div class="placeholder-icon">📋</div>
                    <h4>Drag & Drop Interface</h4>
                    <p>Deze functionaliteit wordt momenteel ontwikkeld...</p>
                    <div class="placeholder-features">
                        <div class="feature-item">
                            <span class="feature-icon">🎯</span>
                            <span>Sleep patiënten naar voertuigen</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">⏰</span>
                            <span>Wijs tijdblokken toe</span>
                        </div>
                        <div class="feature-item">
                            <span class="feature-icon">🔄</span>
                            <span>Real-time updates</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Route Generation -->
        <div class="route-generation" id="routeGeneration" style="display: none;">
            <div class="route-card">
                <div class="route-icon">🗺️</div>
                <div class="route-content">
                    <h3>Route Generatie</h3>
                    <p>Genereer optimale routes met Google Maps API voor alle toegewezen patiënten.</p>
                    
                    <button class="btn btn-primary" onclick="generateRoutes()">
                        <span class="btn-icon">🗺️</span>
                        Genereer Routes
                    </button>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="goBack()">
                <span class="btn-icon">⬅️</span>
                Terug
            </button>
            <button class="btn btn-primary" id="nextStepBtn" onclick="saveAndContinue()" style="display: none;">
                <span class="btn-icon">💾</span>
                Opslaan & Voltooien
            </button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load constraints on page load
    loadConstraints();
});

function loadConstraints() {
    fetch('{% url "api_wizard_constraints" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayConstraints(data.constraints);
            }
        })
        .catch(error => {
            console.error('Error loading constraints:', error);
        });
}

function displayConstraints(constraints) {
    const constraintList = document.getElementById('constraintList');
    constraintList.innerHTML = '';
    
    constraints.forEach(constraint => {
        const li = document.createElement('li');
        li.innerHTML = `
            <span class="constraint-name">${constraint.name}</span>
            <span class="constraint-type ${constraint.weight.toLowerCase()}">${constraint.weight}</span>
        `;
        constraintList.appendChild(li);
    });
}

function startAutoAssignment() {
    // Show progress
    const progressCard = document.querySelector('.progress-card');
    progressCard.innerHTML = `
        <div class="progress-icon">⏳</div>
        <div class="progress-content">
            <h3>Tijdblok-toewijzing Uitvoeren</h3>
            <p>Patiënten worden automatisch toegewezen aan tijdblokken op basis van hun start/eind tijden...</p>
            <div class="loading-spinner">🔄</div>
        </div>
    `;
    
    // Call API voor tijdblok-toewijzing
    fetch('{% url "api_wizard_auto_assign" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('API Response:', data);
        console.log('Timeslot names:', data.data?.timeslot_names);
        if (data.success) {
            showAssignmentResults(data.data);
        } else {
            showAssignmentError(data.error || 'Onbekende fout');
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        showAssignmentError('Fout bij uitvoeren tijdblok-toewijzing: ' + error.message);
    });
}

function showAssignmentResults(result) {
    // Hide progress and show results
    document.getElementById('assignmentProgress').style.display = 'none';
    document.getElementById('assignmentResults').style.display = 'block';
    document.getElementById('manualAssignment').style.display = 'block';
    document.getElementById('routeGeneration').style.display = 'block';
    
    const details = document.getElementById('assignmentDetails');
    const stats = result.statistics || {};
    
    details.innerHTML = `
        <div class="detail-item">
            <strong>Totaal Patiënten:</strong> ${stats.total_patients || 0}
        </div>
        <div class="detail-item">
            <strong>Toegewezen:</strong> ${stats.assigned_patients || 0}
        </div>
        <div class="detail-item">
            <strong>Niet Toegewezen:</strong> ${stats.unassigned_patients || 0}
        </div>
        <div class="detail-item">
            <strong>Succes Percentage:</strong> ${(stats.assignment_rate || 0).toFixed(1)}%
        </div>
        <div class="detail-item">
            <strong>Tijdblokken Gebruikt:</strong> ${stats.timeslots_used || 0}
        </div>
        <div class="detail-item">
            <strong>Beschikbare Voertuigen:</strong> ${stats.available_vehicles || 0}
        </div>
        <div class="detail-item">
            <strong>Capaciteit per Tijdblok:</strong> ${stats.vehicle_capacity || 0} patiënten
        </div>
    `;
    
    // Show timeslot assignments in the manual assignment area
    const timeslotAssignments = result.timeslot_assignments || {};
    const timeslotNames = result.timeslot_names || {};
    console.log('Calling showTimeslotAssignments with:', { timeslotAssignments, timeslotNames });
    showTimeslotAssignments(timeslotAssignments, timeslotNames);
}

function showAssignmentError(error) {
    // Hide progress and show error
    document.getElementById('assignmentProgress').style.display = 'none';
    document.getElementById('assignmentResults').style.display = 'block';
    
    const details = document.getElementById('assignmentDetails');
    details.innerHTML = `
        <div class="detail-item error">
            <strong>❌ Fout:</strong> ${error}
        </div>
    `;
}

function showTimeslotAssignments(timeslotAssignments, timeslotNames) {
    const dragDropArea = document.getElementById('dragDropArea');
    
    console.log('Timeslot assignments:', timeslotAssignments);
    console.log('Timeslot names:', timeslotNames);
    
    // Veilige fallback als timeslotNames niet bestaat
    if (!timeslotNames) {
        console.warn('Timeslot names not provided, using fallback');
        timeslotNames = {};
    }
    
    if (!timeslotAssignments || Object.keys(timeslotAssignments).length === 0) {
        dragDropArea.innerHTML = `
            <div class="drag-drop-placeholder">
                <div class="placeholder-icon">📋</div>
                <h4>Geen Tijdblok-toewijzingen</h4>
                <p>Er zijn geen patiënten toegewezen aan tijdblokken.</p>
            </div>
        `;
        return;
    }
    
    // Sorteer tijdblokken: eerst halen (oplopend), dan brengen (oplopend)
    const sortedTimeslots = Object.entries(timeslotAssignments).sort(([idA, patientsA], [idB, patientsB]) => {
        const infoA = timeslotNames[idA] || { tijdblok_type: 'onbekend', aankomst_tijd: '00:00' };
        const infoB = timeslotNames[idB] || { tijdblok_type: 'onbekend', aankomst_tijd: '00:00' };
        
        // Eerst halen, dan brengen
        if (infoA.tijdblok_type !== infoB.tijdblok_type) {
            return infoA.tijdblok_type === 'halen' ? -1 : 1;
        }
        
        // Dan sorteren op tijd (oplopend)
        return infoA.aankomst_tijd.localeCompare(infoB.aankomst_tijd);
    });
    
    let html = '<div class="timeslot-assignments">';
    
    for (const [timeslotId, patients] of sortedTimeslots) {
        const timeslotInfo = timeslotNames[timeslotId] || { naam: `Tijdblok ${timeslotId}`, aankomst_tijd: '?', tijdblok_type: 'onbekend' };
        const typeIcon = timeslotInfo.tijdblok_type === 'halen' ? '🚐' : '🏠';
        const cardClass = timeslotInfo.tijdblok_type === 'halen' ? 'timeslot-card halen' : 'timeslot-card brengen';
        
        html += `
            <div class="${cardClass}">
                <h4>${typeIcon} ${timeslotInfo.naam} (${timeslotInfo.aankomst_tijd})</h4>
                <div class="timeslot-info">
                    <span class="patient-count">${patients.length} patiënten</span>
                </div>
                <div class="patient-list">
        `;
        
        patients.forEach(patient => {
            console.log('Patient data:', patient);
            
            // Veilige tijd formatting
            let startTime = '?';
            let endTime = '?';
            
            if (patient.start_time) {
                if (typeof patient.start_time === 'string') {
                    startTime = patient.start_time;
                } else if (patient.start_time.strftime) {
                    startTime = patient.start_time.strftime('%H:%M');
                } else {
                    startTime = patient.start_time.toString();
                }
            }
            
            if (patient.end_time) {
                if (typeof patient.end_time === 'string') {
                    endTime = patient.end_time;
                } else if (patient.end_time.strftime) {
                    endTime = patient.end_time.strftime('%H:%M');
                } else {
                    endTime = patient.end_time.toString();
                }
            }
            
            html += `
                <div class="patient-item">
                    <span class="patient-name">${patient.voornaam || ''} ${patient.achternaam || ''}</span>
                    <span class="patient-time">${startTime} - ${endTime}</span>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    html += '</div>';
    dragDropArea.innerHTML = html;
}

function generateRoutes() {
    // Simulate route generation
    const routeBtn = document.querySelector('#routeGeneration .btn');
    routeBtn.innerHTML = '<span class="btn-icon">⏳</span> Routes Genereren...';
    routeBtn.disabled = true;
    
    setTimeout(() => {
        routeBtn.innerHTML = '<span class="btn-icon">✅</span> Routes Voltooid!';
        routeBtn.style.background = '#28a745';
    }, 3000);
}

function saveAndContinue() {
    // Save planning and redirect to results
    window.location.href = '{% url "planning_wizard_routes" %}';
}

function goBack() {
    window.location.href = '{% url "planning_wizard_upload" %}';
}

function switchView(viewType) {
    // Update active button
    document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`[data-view="${viewType}"]`).classList.add('active');
    
    // Update placeholder content based on view
    const placeholder = document.querySelector('.drag-drop-placeholder');
    const placeholderIcon = document.querySelector('.placeholder-icon');
    const placeholderTitle = document.querySelector('.drag-drop-placeholder h4');
    const placeholderDesc = document.querySelector('.drag-drop-placeholder p');
    
    switch(viewType) {
        case 'vehicles':
            placeholderIcon.textContent = '🚐';
            placeholderTitle.textContent = 'Voertuigen Overzicht';
            placeholderDesc.textContent = 'Bekijk en beheer voertuig toewijzingen...';
            break;
        case 'patients':
            placeholderIcon.textContent = '👥';
            placeholderTitle.textContent = 'Patiënten Overzicht';
            placeholderDesc.textContent = 'Bekijk en beheer patiënt toewijzingen...';
            break;
        case 'timeslots':
            placeholderIcon.textContent = '⏰';
            placeholderTitle.textContent = 'Tijdblokken Overzicht';
            placeholderDesc.textContent = 'Bekijk en beheer tijdblok toewijzingen...';
            break;
    }
}
</script>

<style>
.wizard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.wizard-progress {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 3rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 12px;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0.5;
    transition: opacity 0.3s;
}

.progress-step.active {
    opacity: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.progress-step.active .step-number {
    background: #F8CD46;
}

.step-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: #6c757d;
}

.progress-line {
    width: 100px;
    height: 2px;
    background: #dee2e6;
    margin: 0 1rem;
}

.assignment-section {
    margin-bottom: 3rem;
}

.assignment-section h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: #2c3e50;
    text-align: center;
}

.section-description {
    font-size: 1.1rem;
    color: #6c757d;
    margin-bottom: 2rem;
    text-align: center;
}

.assignment-progress {
    margin-bottom: 2rem;
}

.progress-card {
    display: flex;
    align-items: center;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.progress-icon {
    font-size: 3rem;
    margin-right: 1.5rem;
}

.progress-content h3 {
    margin-bottom: 0.5rem;
    color: #2c3e50;
}

.progress-content p {
    color: #6c757d;
    margin-bottom: 1.5rem;
}

.constraint-summary {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.constraint-summary h4 {
    margin-bottom: 0.5rem;
    color: #2c3e50;
}

.constraint-summary ul {
    list-style: none;
    padding: 0;
}

.constraint-summary li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.25rem 0;
    color: #6c757d;
}

.constraint-type {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
}

.constraint-type.hard {
    background: #dc3545;
    color: white;
}

.constraint-type.soft {
    background: #ffc107;
    color: #212529;
}

.assignment-results {
    margin-bottom: 2rem;
}

.result-card {
    display: flex;
    align-items: center;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.result-icon {
    font-size: 2rem;
    margin-right: 1rem;
}

.result-content h3 {
    margin-bottom: 0.5rem;
    color: #155724;
}

.detail-item {
    margin-bottom: 0.25rem;
    color: #155724;
}

.manual-assignment {
    margin-bottom: 2rem;
}

.manual-assignment h3 {
    margin-bottom: 1rem;
    color: #2c3e50;
}

.view-toggle {
    display: flex;
    gap: 1rem;
    margin-bottom: 2rem;
    justify-content: center;
}

.view-btn {
    padding: 0.75rem 1.5rem;
    border: 2px solid #dee2e6;
    background: white;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.3s ease;
}

.view-btn:hover {
    border-color: #F8CD46;
    transform: translateY(-2px);
}

.view-btn.active {
    background: #F8CD46;
    border-color: #F8CD46;
    color: #333;
}

.drag-drop-area {
    background: white;
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 3rem;
    text-align: center;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.drag-drop-placeholder {
    max-width: 500px;
}

.placeholder-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.drag-drop-placeholder h4 {
    color: #2c3e50;
    margin-bottom: 0.5rem;
    font-size: 1.5rem;
}

.drag-drop-placeholder p {
    color: #6c757d;
    margin-bottom: 2rem;
}

.placeholder-features {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    align-items: center;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #6c757d;
    font-size: 0.9rem;
}

.feature-icon {
    font-size: 1.2rem;
}

.loading-spinner {
    font-size: 2rem;
    animation: spin 1s linear infinite;
    margin: 1rem 0;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.timeslot-assignments {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    width: 100%;
}

.timeslot-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
}

.timeslot-card.halen {
    border-left: 4px solid #F8CD46;
    background: linear-gradient(135deg, #fff 0%, #fff9e6 100%);
}

.timeslot-card.brengen {
    border-left: 4px solid #6c757d;
    background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
}

.timeslot-card h4 {
    color: #2c3e50;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    font-weight: 600;
}

.timeslot-card.halen h4 {
    border-bottom: 2px solid #F8CD46;
    color: #d4a017;
}

.timeslot-card.brengen h4 {
    border-bottom: 2px solid #6c757d;
    color: #495057;
}

.timeslot-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.5rem;
    background: rgba(0,0,0,0.05);
    border-radius: 4px;
}

.patient-count {
    font-size: 0.9rem;
    font-weight: 600;
    color: #495057;
    background: #e9ecef;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
}

.patient-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.patient-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 4px;
    border-left: 3px solid #28a745;
}

.patient-name {
    font-weight: 500;
    color: #2c3e50;
}

.patient-time {
    font-size: 0.9rem;
    color: #6c757d;
    background: #e9ecef;
    padding: 0.2rem 0.5rem;
    border-radius: 3px;
}

.detail-item.error {
    color: #dc3545;
    background: #f8d7da;
    padding: 0.5rem;
    border-radius: 4px;
    border-left: 4px solid #dc3545;
}

.route-generation {
    margin-bottom: 2rem;
}

.route-card {
    display: flex;
    align-items: center;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.route-icon {
    font-size: 3rem;
    margin-right: 1.5rem;
}

.route-content h3 {
    margin-bottom: 0.5rem;
    color: #2c3e50;
}

.route-content p {
    color: #6c757d;
    margin-bottom: 1.5rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.btn {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: linear-gradient(135deg, #F8CD46, #f39c12);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(248, 205, 70, 0.3);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-icon {
    margin-right: 0.5rem;
}

@media (max-width: 768px) {
    .wizard-container {
        padding: 1rem;
    }
    
    .assignment-section h1 {
        font-size: 2rem;
    }
    
    .assignment-grid {
        grid-template-columns: 1fr;
    }
    
    .action-buttons {
        flex-direction: column;
    }
}
</style>
{% endblock %}
