{% extends 'planning/base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
{% csrf_token %}
<div class="wizard-container">
    <!-- Progress Bar -->
    <div class="wizard-progress">
        <div class="progress-step completed">
            <div class="step-number">✓</div>
            <div class="step-label">Upload</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step completed">
            <div class="step-number">✓</div>
            <div class="step-label">Preview & Validatie</div>
        </div>
        <div class="progress-line"></div>
        <div class="progress-step active">
            <div class="step-number">3</div>
            <div class="step-label">Auto-Assignment & Routes</div>
        </div>
    </div>

    <!-- Assignment Section -->
    <div class="assignment-section">
        <h1>🚗 Auto-Assignment & Route Generatie</h1>
        <p class="section-description">
            Configureer constraints, start auto-assignment en genereer geoptimaliseerde routes.
        </p>
        
        <!-- Constraints Configuration -->
        <div class="constraints-section">
            <div class="constraints-header">
                <h3>⚙️ Planning Constraints</h3>
                <div class="constraints-actions">
                    <button class="btn btn-sm btn-secondary" onclick="resetConstraints()">
                        <span class="btn-icon">🔄</span>
                        Reset
                    </button>
                    <button class="btn btn-sm btn-primary" onclick="saveConstraints()">
                        <span class="btn-icon">💾</span>
                        Opslaan
                    </button>
                    <button class="btn btn-primary" onclick="generateRoutes()">
                        <span class="btn-icon">🚀</span>
                        Herbereken Routes
                    </button>
                </div>
        </div>

            <div class="constraints-grid">
                <div class="constraint-item">
                    <label class="constraint-toggle">
                        <input type="checkbox" id="constraint_distance" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="constraint-info">
                        <span class="constraint-name">Afstand</span>
                        <span class="constraint-type soft">SOFT</span>
            </div>
        </div>

                <div class="constraint-item">
                    <label class="constraint-toggle">
                        <input type="checkbox" id="constraint_cost" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="constraint-info">
                        <span class="constraint-name">Kosten</span>
                        <span class="constraint-type soft">SOFT</span>
                    </div>
                    </div>
                    
                <div class="constraint-item">
                    <label class="constraint-toggle">
                        <input type="checkbox" id="constraint_drv_count" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="constraint-info">
                        <span class="constraint-name">DRV Aantal</span>
                        <span class="constraint-type soft">SOFT</span>
            </div>
        </div>

                <div class="constraint-item">
                    <label class="constraint-toggle">
                        <input type="checkbox" id="constraint_vehicle_pref" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="constraint-info">
                        <span class="constraint-name">Voorkeurs Voertuig</span>
                        <span class="constraint-type hard">HARD</span>
                    </div>
            </div>
            
                <div class="constraint-item">
                    <label class="constraint-toggle">
                        <input type="checkbox" id="constraint_vehicle_capacity" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="constraint-info">
                        <span class="constraint-name">Voertuig Capaciteit</span>
                        <span class="constraint-type hard">HARD</span>
                        </div>
                        </div>
                
                <div class="constraint-item">
                    <label class="constraint-toggle">
                        <input type="checkbox" id="constraint_vehicle_time" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="constraint-info">
                        <span class="constraint-name">Voertuig Rijtijd</span>
                        <span class="constraint-type hard">HARD</span>
            </div>
        </div>

                <div class="constraint-item">
                    <label class="constraint-toggle">
                        <input type="checkbox" id="constraint_special_capacity" checked>
                        <span class="toggle-slider"></span>
                    </label>
                    <div class="constraint-info">
                        <span class="constraint-name">Speciale Capaciteit</span>
                        <span class="constraint-type hard">HARD</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Google Maps Status -->
        <div class="status-indicator">
            <span class="status-icon">🔍</span>
            <span class="status-text">Google Maps API status wordt gecontroleerd...</span>
</div>

        <!-- Auto-toewijzing Resultaten -->
        <div class="assignment-results" id="assignmentResults">
            <div class="result-card">
                <div class="result-icon">✅</div>
                <div class="result-content">
                    <h3>Auto-toewijzing Voltooid!</h3>
                    <div id="assignmentDetails">
                        <div class="detail-item">Totaal Patiënten: <span id="totalPatients">0</span></div>
                        <div class="detail-item">Toegewezen: <span id="assignedPatients">0</span></div>
                        <div class="detail-item">Niet Toegewezen: <span id="unassignedPatients">0</span></div>
                        <div class="detail-item">Succes Percentage: <span id="successPercentage">0%</span></div>
                        <div class="detail-item">Tijdblokken Gebruikt: <span id="timeslotsUsed">0</span></div>
                        <div class="detail-item">Beschikbare Voertuigen: <span id="availableVehicles">0</span></div>
                        <div class="detail-item">Capaciteit per Tijdblok: <span id="capacityPerTimeslot">0</span> patiënten</div>
                </div>
                </div>
            </div>
        </div>

        <!-- Tijdsblokken Overzicht -->
        <div class="timeslots-overview" id="timeslotsOverview">
            <h3>📅 Tijdsblokken & Patiënten Overzicht</h3>
            
            <!-- Django Tijdsblokken -->
            <div class="django-timeslots">
                <h4>🗓️ Django Admin Tijdsblokken</h4>
                <div class="timeslots-list">
                    {% for timeslot in active_timeslots %}
                    <div class="timeslot-item">
                        <div class="timeslot-header">
                            <span class="timeslot-time">{{ timeslot.aankomst_tijd|time:'H:i' }}</span>
                            <span class="timeslot-type {{ timeslot.tijdblok_type }}">
                                {% if timeslot.tijdblok_type == 'halen' %}🚐 Halen{% else %}🏠 Brengen{% endif %}
                            </span>
                            <span class="timeslot-name">{{ timeslot.naam }}</span>
        </div>
                                                    <div class="timeslot-patients">
                                {% if timeslot.matched_patients %}
                                    {% for patient_name in timeslot.matched_patients %}
                                        {% for patient in patients_data %}
                                            {% if patient.naam == patient_name %}
                                                                                        <div class="patient-assignment">
                                            <span class="patient-name">{{ patient.naam }} {{ patient.ophaal_tijd }}/{{ patient.eind_behandel_tijd }}</span>
                                            <span class="patient-address">{{ patient.adres }}</span>
                                            <span class="patient-vehicle">🚗 {{ patient.toegewezen_voertuig }}</span>
        </div>
                                            {% endif %}
                                        {% endfor %}
                                    {% endfor %}
                                {% else %}
                                    <div class="no-patients" style="color: #6c757d; font-style: italic;">
                                        {% if timeslot.tijdblok_type == 'halen' %}
                                            Geen patiënten voor ophaal om {{ timeslot.aankomst_tijd|time:'H:i' }}
                                        {% else %}
                                            Geen patiënten voor terugbreng om {{ timeslot.aankomst_tijd|time:'H:i' }}
                                        {% endif %}
        </div>
                                {% endif %}
        </div>
        </div>
                    {% empty %}
                    <div class="no-timeslots">
                        <p>⚠️ Geen actieve tijdsblokken gevonden in Django admin.</p>
                        <p>Ga naar Django admin → TimeSlots om tijdsblokken aan te maken.</p>
        </div>
                    {% endfor %}
        </div>
        </div>

        <!-- Niet-toegewezen Patiënten -->
        {% if unassigned_patients %}
        <div class="unassigned-patients-section" style="margin-top: 2rem; padding: 1.5rem; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px;">
            <h3 style="color: #856404; margin-bottom: 1rem;">⚠️ Niet-toegewezen Patiënten ({{ unassigned_patients|length }})</h3>
            <p style="color: #856404; margin-bottom: 1rem;">Deze patiënten konden niet automatisch gekoppeld worden aan tijdsblokken:</p>
            
            {% for patient in unassigned_patients %}
            <div class="unassigned-patient" style="background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 6px; border-left: 4px solid #ffc107;">
                <div style="display: flex; justify-content: space-between; align-items: start;">
                                        <div>
                        <h4 style="margin: 0 0 0.5rem 0; color: #333;">{{ patient.naam }} {{ patient.ophaal_tijd }}/{{ patient.eind_tijd }}</h4>
                        <p style="margin: 0; color: #666;">
                            <strong>Ophaaltijd:</strong> {{ patient.ophaal_tijd }} | 
                            <strong>Eindtijd:</strong> {{ patient.eind_tijd }}
                        </p>
        </div>
                    <div style="text-align: right;">
                        <span style="background: #dc3545; color: white; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                            Niet toegewezen
                        </span>
            </div>
                </div>
                
                <div style="margin-top: 0.75rem; padding: 0.75rem; background: #f8f9fa; border-radius: 4px;">
                    <h5 style="margin: 0 0 0.5rem 0; color: #495057; font-size: 0.9rem;">🔍 Probleem analyse:</h5>
                    {% if patient.haal_probleem %}
                    <p style="margin: 0.25rem 0; color: #dc3545; font-size: 0.85rem;">
                        <strong>Halen:</strong> {{ patient.haal_probleem }}
                    </p>
                    {% endif %}
                    {% if patient.breng_probleem %}
                    <p style="margin: 0.25rem 0; color: #dc3545; font-size: 0.85rem;">
                        <strong>Brengen:</strong> {{ patient.breng_probleem }}
                    </p>
                    {% endif %}
                </div>
                
                <div style="margin-top: 0.75rem;">
                    <button class="btn btn-sm btn-outline-primary" onclick="suggestTimeslot('{{ patient.naam }}', '{{ patient.ophaal_tijd }}', '{{ patient.eind_tijd }}')">
                        💡 Voeg tijdsblok toe
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="manualAssign('{{ patient.naam }}')">
                        ✏️ Handmatig toewijzen
                    </button>
                </div>
            </div>
            {% endfor %}
            
            <div style="margin-top: 1rem; padding: 1rem; background: #e7f3ff; border-radius: 6px; border-left: 4px solid #007bff;">
                <h5 style="margin: 0 0 0.5rem 0; color: #004085;">💡 Oplossingen:</h5>
                <ul style="margin: 0; color: #004085; font-size: 0.9rem;">
                    <li>Voeg nieuwe tijdsblokken toe in Django admin</li>
                    <li>Pas de tijden van bestaande tijdsblokken aan</li>
                    <li>Wijzig de patiënt tijden in het CSV bestand</li>
                </ul>
        </div>
        </div>
        {% endif %}
            


        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="goBack()">
                <span class="btn-icon">⬅️</span>
                Terug
            </button>
            <button class="btn btn-primary" onclick="saveAndContinue()">
                <span class="btn-icon">💾</span>
                Opslaan & Volgende
            </button>
                </div>
                </div>
                </div>

<style>
.wizard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.wizard-progress {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 3rem;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 12px;
}

.progress-step {
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0.5;
    transition: opacity 0.3s;
}

.progress-step.active {
    opacity: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #6c757d;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.progress-step.active .step-number {
    background: #F8CD46;
}

.progress-step.completed .step-number {
    background: #28a745;
}

.step-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: #6c757d;
}

.progress-line {
    width: 80px;
    height: 2px;
    background: #dee2e6;
    margin: 0 1rem;
}

.assignment-section {
    margin-bottom: 3rem;
}

.assignment-section h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: #2c3e50;
    text-align: center;
}

.section-description {
    font-size: 1.1rem;
    color: #6c757d;
    margin-bottom: 2rem;
    text-align: center;
}

/* Constraints Section */
.constraints-section {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.constraints-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.constraints-header h3 {
    margin: 0;
    color: #2c3e50;
    font-size: 1.2rem;
}

.constraints-actions {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
}

.constraints-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 0.75rem;
}

.constraint-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px solid #e9ecef;
    transition: all 0.2s;
}

.constraint-item:hover {
    background: #e9ecef;
    border-color: #dee2e6;
}

.constraint-toggle {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
    flex-shrink: 0;
}

.constraint-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .3s;
    border-radius: 20px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 16px;
    width: 16px;
    left: 2px;
    bottom: 2px;
    background-color: white;
    transition: .3s;
    border-radius: 50%;
}

.constraint-toggle input:checked + .toggle-slider {
    background-color: #28a745;
}

.constraint-toggle input:checked + .toggle-slider:before {
    transform: translateX(20px);
}

.constraint-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    flex: 1;
}

.constraint-name {
    color: #2c3e50;
    font-size: 0.9rem;
    font-weight: 500;
}

.constraint-type {
    display: inline-block;
    padding: 0.2rem 0.4rem;
    border-radius: 8px;
    font-size: 0.65rem;
    font-weight: bold;
    text-transform: uppercase;
    align-self: flex-start;
}

.constraint-type.soft {
    background: #fff3cd;
    color: #856404;
}

.constraint-type.hard {
    background: #f8d7da;
    color: #721c24;
}

.btn-sm {
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.status-indicator {
    display: flex;
    align-items: center;
    padding: 0.75rem 1rem;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    margin: 1rem 0;
}

.status-icon {
    font-size: 1.2rem;
    margin-right: 0.5rem;
}

.status-text {
    font-weight: 500;
    color: #495057;
}

.assignment-results {
    margin-bottom: 2rem;
}

.result-card {
    display: flex;
    align-items: center;
    background: #d4edda;
    border: 1px solid #c3e6cb;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.result-icon {
    font-size: 2rem;
    margin-right: 1rem;
}

.result-content h3 {
    margin-bottom: 0.5rem;
    color: #155724;
}

.detail-item {
    margin-bottom: 0.25rem;
    color: #155724;
}

.route-generation {
    margin-bottom: 2rem;
}

.route-card {
    display: flex;
    align-items: center;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.route-icon {
    font-size: 3rem;
    margin-right: 1.5rem;
}

.route-content h3 {
    margin-bottom: 0.5rem;
    color: #2c3e50;
}

.route-content p {
    color: #6c757d;
    margin-bottom: 1.5rem;
}

.manual-assignment {
    margin-bottom: 2rem;
}

.manual-assignment h3 {
    margin-bottom: 1rem;
    color: #2c3e50;
}

/* Tijdsblokken Styling */
.timeslots-overview {
    margin-bottom: 2rem;
}

.timeslots-overview h3 {
    color: #2c3e50;
    margin-bottom: 1rem;
    font-size: 1.5rem;
}

.timeslots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.timeslot-card {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.timeslot-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

.timeslot-header h4 {
    color: #2c3e50;
    margin: 0;
    font-size: 1.1rem;
}

.vehicle-info {
    background: #e3f2fd;
    color: #1976d2;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

.patients-list {
    margin-bottom: 1rem;
}

.patient-item {
    display: flex;
    flex-direction: column;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 0.5rem;
}

.patient-name {
    font-weight: 600;
    color: #2c3e50;
    margin-bottom: 0.25rem;
}

.patient-address {
    font-size: 0.85rem;
    color: #6c757d;
}

.timeslot-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.5rem;
    border-top: 1px solid #e9ecef;
}

.capacity-info {
    background: #d4edda;
    color: #155724;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
}

/* Django Timeslots Styling */
.django-timeslots {
    margin-bottom: 2rem;
}

.timeslots-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.timeslot-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.timeslot-item .timeslot-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #e9ecef;
}

.timeslot-item .timeslot-time {
    font-size: 1.2rem;
    font-weight: bold;
    color: #2c3e50;
    min-width: 60px;
}

.timeslot-type {
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
}

.timeslot-type.halen {
    background: #d4edda;
    color: #155724;
}

.timeslot-type.brengen {
    background: #d1ecf1;
    color: #0c5460;
}

.timeslot-name {
    color: #6c757d;
    font-size: 0.9rem;
}

.timeslot-patients {
    min-height: 60px;
}

.patient-assignment {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
}

.patient-assignment .patient-name {
    font-weight: 600;
    color: #2c3e50;
}

.patient-assignment .patient-address {
    font-size: 0.85rem;
    color: #6c757d;
}

.patient-assignment .patient-vehicle {
    font-size: 0.8rem;
    color: #28a745;
    font-weight: 500;
}

.no-patients {
    text-align: center;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 6px;
    border: 1px dashed #dee2e6;
}

.no-timeslots {
    text-align: center;
    padding: 2rem;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
    color: #856404;
}

.drag-drop-area {
    background: white;
    border: 2px dashed #dee2e6;
    border-radius: 12px;
    padding: 3rem;
    text-align: center;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.drag-drop-placeholder {
    max-width: 500px;
}

.placeholder-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
}

.drag-drop-placeholder h4 {
    color: #2c3e50;
    margin-bottom: 0.5rem;
    font-size: 1.5rem;
}

.drag-drop-placeholder p {
    color: #6c757d;
    margin-bottom: 2rem;
}

.action-buttons {
    display: flex;
    gap: 1rem;
    justify-content: center;
}

.btn {
    display: inline-flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
}

.btn-primary {
    background: linear-gradient(135deg, #F8CD46, #f39c12);
    color: white;
}

.btn-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(248, 205, 70, 0.3);
}

.btn-secondary {
    background: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background: #5a6268;
}

.btn-icon {
    margin-right: 0.5rem;
}

@media (max-width: 768px) {
    .wizard-container {
        padding: 1rem;
    }
    
    .assignment-section h1 {
        font-size: 2rem;
    }
    
    .action-buttons {
        flex-direction: column;
    }
}
</style>

<script>
// Planning Wizard Assignment JavaScript

document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Assignment pagina geladen');
    
    // Laad constraints uit session storage
    loadConstraints();
    
    // Start auto-assignment
    startAutoAssignment();
    
    // Controleer Google Maps status
    checkGoogleMapsStatus();
});

// Constraints Management
function resetConstraints() {
    document.querySelectorAll('.constraint-toggle input').forEach(input => {
        input.checked = true;
    });
    updateConstraintList();
    alert('Constraints gereset naar standaard waarden');
}

function saveConstraints() {
    const constraints = {};
    document.querySelectorAll('.constraint-toggle input').forEach(input => {
        constraints[input.id] = input.checked;
    });
    sessionStorage.setItem('planning_constraints', JSON.stringify(constraints));
    updateConstraintList();
    alert('Constraints opgeslagen!');
}

function loadConstraints() {
    const savedConstraints = sessionStorage.getItem('planning_constraints');
    if (savedConstraints) {
        const constraints = JSON.parse(savedConstraints);
        Object.keys(constraints).forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.checked = constraints[id];
            }
        });
    }
    updateConstraintList();
}

function updateConstraintList() {
    const activeConstraints = [];
    document.querySelectorAll('.constraint-toggle input:checked').forEach(input => {
        const constraintName = input.id.replace('constraint_', '').replace('_', ' ');
        activeConstraints.push(constraintName);
    });
    
    console.log('✅ Actieve constraints:', activeConstraints);
}

// Auto-Assignment
function startAutoAssignment() {
    console.log('🚀 Start auto-assignment...');
    
    // Toon tijdsblokken direct
    showAssignmentResults();
    showTimeslotsOverview();
}

function showAssignmentResults() {
    const resultsDiv = document.getElementById('assignmentResults');
    const detailsDiv = document.getElementById('assignmentDetails');
    
    // Bereken echte statistieken
    const totalPatients = {{ patients_data|length }};
    const unassignedCount = {{ unassigned_patients|length }};
    const assignedCount = totalPatients - unassignedCount;
    const successPercentage = totalPatients > 0 ? Math.round((assignedCount / totalPatients) * 100) : 0;
    const timeslotsUsed = {{ active_timeslots|length }};
    const availableVehicles = {{ available_vehicles|length }};
    const capacityPerTimeslot = availableVehicles > 0 ? Math.floor(49 / availableVehicles) : 0;
    
    // Update resultaten
    document.getElementById('totalPatients').textContent = totalPatients;
    document.getElementById('assignedPatients').textContent = assignedCount;
    document.getElementById('unassignedPatients').textContent = unassignedCount;
    document.getElementById('successPercentage').textContent = successPercentage + '%';
    document.getElementById('timeslotsUsed').textContent = timeslotsUsed;
    document.getElementById('availableVehicles').textContent = availableVehicles;
    document.getElementById('capacityPerTimeslot').textContent = capacityPerTimeslot;
    
    resultsDiv.style.display = 'block';
}

function showTimeslotsOverview() {
    const overviewDiv = document.getElementById('timeslotsOverview');
    const gridDiv = document.getElementById('timeslotsGrid');
    
    // Genereer tijdsblokken
    const timeslots = generateTimeslots();
    
    gridDiv.innerHTML = timeslots.map(timeslot => `
        <div class="timeslot-card">
            <div class="timeslot-header">
                <h4>${timeslot.time}</h4>
                <span class="vehicle-info">${timeslot.vehicle}</span>
            </div>
            <div class="patients-list">
                ${timeslot.patients.map(patient => `
                    <div class="patient-item">
                        <span class="patient-name">${patient.name}</span>
                        <span class="patient-address">${patient.address}</span>
                    </div>
                `).join('')}
            </div>
            <div class="timeslot-footer">
                <span class="capacity-info">${timeslot.patients.length}/${timeslot.capacity} patiënten</span>
            </div>
        </div>
    `).join('');
    
    overviewDiv.style.display = 'block';
}

function generateTimeslots() {
    console.log('🔍 Start generateTimeslots...');
    
    // Haal Django data op
    const djangoDataElement = document.getElementById('django-data');
    if (!djangoDataElement) {
        console.error('❌ Django data element niet gevonden');
        return [];
    }
    
    let djangoData;
    try {
        djangoData = JSON.parse(djangoDataElement.textContent);
        console.log('✅ Django data geparsed:', djangoData);
    } catch (error) {
        console.error('❌ Fout bij parsen Django data:', error);
        return [];
    }
    
    if (!djangoData.timeslots || djangoData.timeslots.length === 0) {
        console.warn('⚠️ Geen tijdsblokken gevonden in Django data');
        return [];
    }
    
    console.log(`📅 ${djangoData.timeslots.length} tijdsblokken gevonden`);
    console.log(`👥 ${djangoData.patients.length} patiënten gevonden`);
    console.log(`🚗 ${djangoData.vehicles.length} voertuigen gevonden`);
    
    const timeslots = [];
    
    // Genereer tijdsblokken op basis van Django TimeSlot data
    djangoData.timeslots.forEach((timeslot, index) => {
        console.log(`🔍 Verwerk tijdsblok ${index + 1}:`, timeslot);
        
        const timeslotInfo = {
            id: timeslot.id,
            time: `${timeslot.time} ${timeslot.type === 'halen' ? '🚐' : '🏠'}`,
            type: timeslot.type,
            naam: timeslot.naam,
            max_rijtijd: timeslot.max_rijtijd,
            vehicle: `🚗 ${djangoData.vehicles.length} Beschikbare Voertuigen`,
            capacity: djangoData.vehicles.reduce((total, v) => total + v.capaciteit, 0),
            patients: []
        };
        
        // Koppel patiënten aan dit tijdblok
        djangoData.patients.forEach(patient => {
            if (timeslot.type === 'halen' && patient.ophaal_tijd) {
                // Vergelijk ophaal_tijd met aankomst_tijd van halen tijdblok
                if (patient.ophaal_tijd.includes(timeslot.time.split(' ')[0])) {
                    timeslotInfo.patients.push({
                        name: patient.naam,
                        address: patient.adres,
                        ophaal_tijd: patient.ophaal_tijd
                    });
                    console.log(`✅ Patiënt ${patient.naam} gekoppeld aan halen tijdblok ${timeslot.time}`);
                }
            } else if (timeslot.type === 'brengen' && patient.eind_behandel_tijd) {
                // Vergelijk eind_behandel_tijd met aankomst_tijd van brengen tijdblok
                if (patient.eind_behandel_tijd.includes(timeslot.time.split(' ')[0])) {
                    timeslotInfo.patients.push({
                        name: patient.naam,
                        address: patient.adres,
                        eind_behandel_tijd: patient.eind_behandel_tijd
                    });
                    console.log(`✅ Patiënt ${patient.naam} gekoppeld aan brengen tijdblok ${timeslot.time}`);
                }
            }
        });
        
        timeslots.push(timeslotInfo);
        console.log(`📋 Tijdsblok ${timeslot.time} heeft ${timeslotInfo.patients.length} patiënten`);
    });
    
    console.log(`🎯 Totaal ${timeslots.length} tijdsblokken gegenereerd`);
    return timeslots;
}

// Google Maps Status Check
function checkGoogleMapsStatus() {
    const statusIndicator = document.querySelector('.status-indicator');
    const statusText = statusIndicator.querySelector('.status-text');
    
    setTimeout(() => {
        statusText.textContent = '✅ Google Maps API is beschikbaar';
        statusIndicator.style.color = '#28a745';
    }, 1500);
}

// Route Generation
function generateRoutes() {
    console.log('🗺️ Start route generatie...');
    
    const button = document.querySelector('.route-generation .btn-primary');
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<span class="btn-icon">⏳</span> Routes genereren...';
    
    // Simuleer route generatie
    setTimeout(() => {
        button.innerHTML = '<span class="btn-icon">✅</span> Routes gegenereerd!';
        button.style.background = '#28a745';
        
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = originalText;
            button.style.background = '';
        }, 2000);
    }, 3000);
}

// Niet-toegewezen patiënten functies
function suggestTimeslot(patientName, ophaalTijd, eindTijd) {
    console.log(`💡 Tijdsblok suggestie voor ${patientName}: ophaal=${ophaalTijd}, eind=${eindTijd}`);
    
    // Bereken suggesties
    const ophaalTime = new Date(`2000-01-01 ${ophaalTijd}`);
    const eindTime = new Date(`2000-01-01 ${eindTijd}`);
    
    // Suggestie: 30 minuten na eindtijd voor brengen blok
    const suggestedBrengen = new Date(eindTime.getTime() + 30 * 60000);
    const suggestedBrengenTime = suggestedBrengen.toTimeString().substr(0, 5);
    
    const message = `
🔍 Tijdsblok Suggesties voor ${patientName}:

📅 Huidige tijden:
   • Ophaaltijd: ${ophaalTijd}
   • Eindtijd: ${eindTijd}

💡 Voorgestelde nieuwe tijdsblokken:
   • Halen blok: ${ophaalTijd} (of eerder)
   • Brengen blok: ${suggestedBrengenTime} (30 min na eindtijd)

📝 Acties:
   1. Ga naar Django Admin → TimeSlots
   2. Voeg nieuw tijdsblok toe: ${suggestedBrengenTime} (brengen)
   3. Herlaad deze pagina
    `;
    
    alert(message);
}

function manualAssign(patientName) {
    console.log(`✏️ Handmatige toewijzing voor ${patientName}`);
    
    const message = `
✏️ Handmatige Toewijzing voor ${patientName}:

📋 Opties:
   1. Pas patiënt tijden aan in CSV bestand
   2. Voeg nieuwe tijdsblokken toe in Django admin
   3. Wijzig bestaande tijdsblok tijden

🔄 Na wijzigingen:
   • Herlaad CSV bestand
   • Of herlaad deze pagina
    `;
    
    alert(message);
}

// Navigation
function goBack() {
    window.location.href = '{% url "planning_wizard_preview" %}';
}

function saveAndContinue() {
    console.log('💾 Opslaan en routes genereren...');
    
    const button = document.querySelector('.action-buttons .btn-primary');
    const originalText = button.innerHTML;
    
    button.disabled = true;
    button.innerHTML = '<span class="btn-icon">⏳</span> Routes genereren...';
    
    // Roep route generatie API aan
    fetch('/api/generate-routes/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            button.innerHTML = '<span class="btn-icon">✅</span> Routes gegenereerd!';
            console.log('✅ Routes succesvol gegenereerd:', data);
            
            setTimeout(() => {
                // Ga naar routes pagina
                window.location.href = '{% url "planning_wizard_routes" %}';
            }, 1000);
        } else {
            button.innerHTML = '<span class="btn-icon">❌</span> Fout bij genereren';
            console.error('❌ Fout bij route generatie:', data.error);
            
            setTimeout(() => {
                button.disabled = false;
                button.innerHTML = originalText;
            }, 3000);
        }
    })
    .catch(error => {
        console.error('❌ Netwerkfout bij route generatie:', error);
        button.innerHTML = '<span class="btn-icon">❌</span> Netwerkfout';
        
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        }, 3000);
    });
}
</script>

{% endblock %}
