{% extends 'planning/base.html' %}

{% block title %}Planning - Routemeister{% endblock %}

{% block extra_css %}
<style>
    /* Date Selector */
    .date-selector-container {
        background: white;
        padding: 1rem;
        border-bottom: 2px solid var(--routemeister-light-grey);
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .date-selector-label {
        font-weight: bold;
        color: var(--routemeister-asphalt);
        font-size: 1.1rem;
    }

    .date-selector-input {
        padding: 0.5rem;
        border: 2px solid #e0e0e0;
        border-radius: 5px;
        font-size: 1rem;
        background: white;
        cursor: pointer;
    }

    .date-selector-input:focus {
        outline: none;
        border-color: var(--routemeister-orange);
    }

    .date-selector-btn {
        background: var(--routemeister-orange);
        color: white;
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
    }

    .date-selector-btn:hover {
        background: #e55a2b;
        transform: translateY(-1px);
    }

    .date-selector-info {
        color: #666;
        font-size: 0.9rem;
        margin-left: auto;
    }

    /* Route Results Layout */
    .route-results-container {
        display: flex;
        height: calc(100vh - 180px); /* Adjusted for date selector */
        gap: 0;
        background: var(--routemeister-white);
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(28, 28, 27, 0.15);
    }

    /* Left Panel - Planning Overview */
    .planning-panel {
        width: 100%; /* Changed from 40% to 100% since we removed stats panel */
        background: var(--routemeister-off-white);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    /* Time Bar Container */
    .time-bar-container {
        background: var(--routemeister-asphalt);
        color: var(--routemeister-white);
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 11pt;
    }
    
    /* Time Bar */
    .time-bar {
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        gap: 0.75rem;
    }
    
    .halen-bar {
        background: #F8CD46;
        color: #6c757d;
        border-bottom: 1px solid #ddd;
    }
    
    .brengen-bar {
        background: #6c757d;
        color: #F8CD46;
    }
    
    .time-bar-label {
        font-weight: 700;
        min-width: 60px;
        font-size: 12pt;
    }
    
    .time-segment {
        padding: 0.4rem 0.8rem;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .time-segment.active {
        background: rgba(255, 255, 255, 0.9);
        color: #333;
        transform: scale(1.05);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .time-segment:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.02);
    }
    
    /* Vehicle Columns */
    .vehicle-columns {
        flex: 1;
        padding: 1rem;
        overflow-y: auto;
    }
    
    .vehicle-columns-inner {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .vehicle-column {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    /* Map Panel */
    .map-panel {
        width: 60%;
        position: relative;
    }
    
    #route-map {
        width: 100%;
        height: 100%;
    }
    
    /* Map Controls */
    .map-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 1000;
    }
    
    .map-control-btn {
        background: white;
        border: none;
        border-radius: 4px;
        padding: 8px;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        font-size: 16px;
        transition: all 0.3s ease;
    }
    
    .map-control-btn:hover {
        background: #f8f9fa;
        transform: scale(1.1);
    }
    
    /* Patient Entry */
    .patient-entry {
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .patient-entry:hover {
        background: #f8f9fa;
        transform: translateX(2px);
    }
    
    /* Timeslot Groups */
    .timeslot-group {
        margin-bottom: 2rem;
    }
    
    /* Loading indicator */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        display: none;
    }
    
    .loading-content {
        background: white;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .loading-spinner {
        font-size: 2em;
        color: var(--routemeister-orange);
        margin-bottom: 15px;
    }
    
    .loading-text {
        font-size: 1.1em;
        color: #333;
        margin-bottom: 10px;
    }
    
    .loading-subtext {
        font-size: 0.9em;
        color: #666;
    }
</style>
{% endblock %}

{% block content %}
{% if has_planning %}
<!-- Header met knoppen -->
<div style="background: white; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1 style="margin: 0; color: var(--routemeister-asphalt);">üó∫Ô∏è Route Planning Resultaten</h1>
            <p style="margin: 0.5rem 0 0 0; color: #666;">Overzicht van geplande routes per tijdblok</p>
        </div>
        <div style="display: flex; gap: 1rem;">
            <a href="{% url 'concept_planning' %}" class="btn" style="background: var(--routemeister-orange); color: white; padding: 0.75rem 1.5rem; text-decoration: none; border-radius: 6px; font-weight: bold;">
                ‚úèÔ∏è Bewerken
            </a>
            <a href="{% url 'new_planning' %}" class="btn" style="background: var(--routemeister-yellow); color: var(--routemeister-asphalt); padding: 0.75rem 1.5rem; text-decoration: none; border-radius: 6px; font-weight: bold;">
                üìã Nieuwe Planning
            </a>
        </div>
    </div>
</div>

<div class="route-results-container">
    <!-- Left Panel - Planning Overview -->
    <div class="planning-panel">
        <!-- Date Selector -->
        <div class="date-selector-container">
            <label for="date-selector" class="date-selector-label">üìÖ Selecteer datum:</label>
            <input type="date" id="date-selector" class="date-selector-input" value="{{ selected_date|date:'Y-m-d' }}">
            <button class="date-selector-btn" onclick="loadRoutesForDate()">
                <i class="fas fa-search"></i> Laad Routes
            </button>
            <span class="date-selector-info">
                {{ selected_date|date:"l, d F Y" }}
            </span>
        </div>

        <!-- Time Bar - Two Row Layout -->
        <div class="time-bar-container">
            <div class="time-bar halen-bar">
                <div class="time-bar-label">HALEN</div>
                {% for timeslot in selected_timeslots %}
                    {% if timeslot.heen_start_tijd %}
                    <div class="time-segment" data-timeslot="{{ timeslot.naam }}" onclick="switchTimeslot('{{ timeslot.naam }}')">
                        {{ timeslot.heen_start_tijd|time:"H:i" }} - {{ timeslot.heen_eind_tijd|time:"H:i" }}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="time-bar brengen-bar">
                <div class="time-bar-label">BRENGEN</div>
                {% for timeslot in selected_timeslots %}
                    {% if timeslot.terug_start_tijd %}
                    <div class="time-segment" data-timeslot="{{ timeslot.naam }}" onclick="switchTimeslot('{{ timeslot.naam }}')">
                        {{ timeslot.terug_start_tijd|time:"H:i" }} - {{ timeslot.terug_eind_tijd|time:"H:i" }}
                    </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        
        <!-- Vehicle Columns - Grouped by Timeslot -->
        <div class="vehicle-columns" id="vehicle-columns">
            {% if has_planning %}
                {% for timeslot in selected_timeslots %}
                <div class="timeslot-group" data-timeslot="{{ timeslot.naam }}" {% if not forloop.first %}style="display: none;"{% endif %}>
                    <div class="vehicle-columns-inner">
                        {% for route in routes %}
                            {% if route.timeslot_name == timeslot.naam %}
                            <div class="vehicle-column">
                                <!-- Vehicle Info -->
                                <div style="padding: 0.75rem; background: {{ route.vehicle_color|default:'#F8CD46' }}; color: white; font-size: 11pt; font-weight: bold; text-align: center;">
                                    üöó {{ route.vehicle_referentie|default:route.vehicle_name }} | {{ route.route_type }}
                                </div>
                                
                                <!-- Route Details -->
                                <div style="padding: 0.5rem; background: #f8f9fa; font-size: 9pt; text-align: center; border-bottom: 1px solid #dee2e6;">
                                    üë• {{ route.total_patients }} pati√´nten | üìç {{ route.total_stops }} stops
                                </div>
                                
                                <!-- Stops -->
                                <div style="padding: 0.75rem;">
                                    {% for stop in route.stops %}
                                    <div class="patient-entry" 
                                         data-patient-id="{{ stop.patient_id|default:0 }}"
                                         data-lat="{{ stop.latitude|default:0 }}"
                                         data-lng="{{ stop.longitude|default:0 }}"
                                         style="border-left: 3px solid {{ route.vehicle_color|default:'#F8CD46' }};">
                                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                                            <span style="font-weight: bold; color: #6c757d; background: {{ route.vehicle_color|default:'#F8CD46' }}; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px;">{{ stop.sequence|default:forloop.counter }}</span>
                                            {% if stop.type == 'PICKUP' %}üì•{% elif stop.type == 'DROPOFF' %}üì§{% elif stop.type == 'ORIGIN' %}üè†{% elif stop.type == 'DESTINATION' %}üèÅ{% else %}üìç{% endif %}
                                            <span style="font-size: 10pt;">{{ stop.patient_name|default:stop.location_name|default:"Onbekend" }}</span>
                                        </div>
                                        {% if stop.type and stop.type != 'ORIGIN' and stop.type != 'DESTINATION' %}
                                        <small style="color: #6c757d; font-size: 8pt; margin-left: 28px;">{{ stop.type }}</small>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                        {% empty %}
                            <!-- Lege tijdblok - geen routes -->
                            <div class="vehicle-column" style="opacity: 0.6;">
                                <div style="padding: 0.75rem; background: #f8f9fa; color: #6c757d; font-size: 11pt; font-weight: bold; text-align: center; border: 2px dashed #dee2e6;">
                                    üì≠ Geen routes voor {{ timeslot.naam }}
                                </div>
                                <div style="padding: 0.75rem; text-align: center; color: #6c757d; font-size: 9pt;">
                                    Geen pati√´nten toegewezen aan dit tijdblok
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <!-- Toon routes van geselecteerde datum -->
                {% if selected_date_routes %}
                    {% for route in selected_date_routes %}
                    <div class="vehicle-column">
                        <!-- Vehicle Info -->
                        <div style="padding: 0.75rem; background: {{ route.vehicle_color|default:'#F8CD46' }}; color: white; font-size: 11pt; font-weight: bold; text-align: center;">
                            üöó {{ route.vehicle_referentie|default:route.vehicle_name }} | {{ route.route_type }}
                        </div>
                        
                        <!-- Route Details -->
                        <div style="padding: 0.5rem; background: #f8f9fa; font-size: 9pt; text-align: center; border-bottom: 1px solid #dee2e6;">
                            üë• {{ route.total_patients }} pati√´nten | üìç {{ route.total_stops }} stops
                        </div>
                        
                        <!-- Stops -->
                        <div style="padding: 0.75rem;">
                            {% for stop in route.stops %}
                            <div class="patient-entry" 
                                 data-patient-id="{{ stop.patient_id|default:0 }}"
                                 data-lat="{{ stop.latitude|default:0 }}"
                                 data-lng="{{ stop.longitude|default:0 }}"
                                 style="border-left: 3px solid {{ route.vehicle_color|default:'#F8CD46' }};">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                    <span style="font-weight: bold; color: #6c757d; background: {{ route.vehicle_color|default:'#F8CD46' }}; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 10px;">{{ stop.sequence|default:forloop.counter }}</span>
                                    {% if stop.type == 'PICKUP' %}üì•{% elif stop.type == 'DROPOFF' %}üì§{% elif stop.type == 'ORIGIN' %}üè†{% elif stop.type == 'DESTINATION' %}üèÅ{% else %}üìç{% endif %}
                                    <span style="font-size: 10pt;">{{ stop.patient_name|default:stop.location_name|default:"Onbekend" }}</span>
                                </div>
                                {% if stop.type and stop.type != 'ORIGIN' and stop.type != 'DESTINATION' %}
                                <small style="color: #6c757d; font-size: 8pt; margin-left: 28px;">{{ stop.type }}</small>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- Geen routes gevonden voor deze datum -->
                    <div class="vehicle-column" style="opacity: 0.6;">
                        <div style="padding: 0.75rem; background: #f8f9fa; color: #6c757d; font-size: 11pt; font-weight: bold; text-align: center; border: 2px dashed #dee2e6;">
                            üì≠ Geen routes gevonden
                        </div>
                        <div style="padding: 0.75rem; text-align: center; color: #6c757d; font-size: 9pt;">
                            Geen routes gevonden voor {{ selected_date|date:"d-m-Y" }}
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
    
    <!-- Right Panel - Map -->
    <div class="map-panel">
        <div id="route-map"></div>
        
        <!-- Map Controls -->
        <div class="map-controls">
            <button class="map-control-btn" onclick="fitAllRoutes()" title="Toon alle routes">
                üó∫Ô∏è
            </button>
            <button class="map-control-btn" onclick="toggleRouteVisibility()" title="Toggle route zichtbaarheid">
                üëÅÔ∏è
            </button>
        </div>
    </div>
</div>

<!-- JavaScript for Map and Interactions -->
<script>
    // Route data from Django
    var routes = [
        {% for route in routes %}
        {
            id: {{ forloop.counter }},
            vehicle: {
                kenteken: '{{ route.vehicle_name }}',
                kleur: '{{ route.vehicle_color|default:"#F8CD46" }}'
            },
            timeslot_name: '{{ route.timeslot_name }}',
            route_type: '{{ route.route_type }}',
            stops: [
                {% for stop in route.stops %}
                {
                    id: {{ stop.patient_id|default:0 }},
                    naam: '{{ stop.patient_name|default:stop.location_name }}',
                    latitude: {{ stop.latitude|default:52.3676 }},
                    longitude: {{ stop.longitude|default:4.9041 }},
                    type: '{{ stop.type }}',
                    sequence: {{ stop.sequence|default:0 }}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ]
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Home location (Reha Center)
    var homeLat = {{ home_location.latitude|default:50.8 }};
    var homeLng = {{ home_location.longitude|default:7.0 }};
    
    // Map variables
    var map;
    var routeLayers = [];
    var patientMarkers = [];
    
    // Initialize map
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Leaflet map
        map = L.map('route-map').setView([homeLat, homeLng], 12);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Add home location marker
        var homeMarker = L.marker([homeLat, homeLng], {
            icon: L.divIcon({
                className: 'home-marker',
                html: '<div style="background: #e74c3c; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid white;">üè†</div>',
                iconSize: [30, 30],
                iconAnchor: [15, 15]
            })
        }).addTo(map);
        
        homeMarker.bindPopup('<strong>{{ home_location.name|default:"Reha Center" }}</strong><br>{{ home_location.address|default:"Start- en eindpunt" }}');
        
        // Draw initial routes
        drawRoutes();
        
        // Set initial active timeslot
        const firstTimeslot = document.querySelector('.time-segment');
        if (firstTimeslot) {
            firstTimeslot.classList.add('active');
        }
        
        // Initialize date selector
        initializeDateSelector();
    });
    
    // Date selector functionality
    function initializeDateSelector() {
        const dateInput = document.getElementById('date-selector');
        const today = new Date();
        const fourMonthsAgo = new Date();
        fourMonthsAgo.setMonth(today.getMonth() - 4);
        
        // Set min and max dates
        dateInput.min = fourMonthsAgo.toISOString().split('T')[0];
        dateInput.max = today.toISOString().split('T')[0];
        
        // Update date info when date changes
        dateInput.addEventListener('change', function() {
            updateDateInfo();
        });
    }
    
    function updateDateInfo() {
        const dateInput = document.getElementById('date-selector');
        const dateInfo = document.querySelector('.date-selector-info');
        const selectedDate = new Date(dateInput.value);
        
        const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
        const formattedDate = selectedDate.toLocaleDateString('nl-NL', options);
        dateInfo.textContent = formattedDate;
    }
    
    function loadRoutesForDate() {
        const dateInput = document.getElementById('date-selector');
        const selectedDate = dateInput.value;
        
        if (!selectedDate) {
            alert('Selecteer een datum');
            return;
        }
        
        // Show loading overlay
        showLoadingOverlay('Routes laden voor ' + selectedDate);
        
        // Redirect to the same page with the selected date
        const currentUrl = new URL(window.location);
        currentUrl.searchParams.set('date', selectedDate);
        window.location.href = currentUrl.toString();
    }
    
    function showLoadingOverlay(message) {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
        overlay.style.display = 'flex';
        overlay.innerHTML = `
            <div class="loading-content">
                <div class="loading-spinner">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="loading-text">${message}</div>
                <div class="loading-subtext">Even geduld...</div>
            </div>
        `;
        document.body.appendChild(overlay);
    }
    
    function switchTimeslot(timeslotName) {
        // Remove active class from all time segments
        document.querySelectorAll('.time-segment').forEach(segment => {
            segment.classList.remove('active');
        });
        
        // Add active class to clicked segment
        document.querySelectorAll(`[data-timeslot="${timeslotName}"]`).forEach(segment => {
            segment.classList.add('active');
        });
        
        // Hide all timeslot groups
        document.querySelectorAll('.timeslot-group').forEach(group => {
            group.style.display = 'none';
        });
        
        // Show selected timeslot group
        const selectedGroup = document.querySelector(`[data-timeslot="${timeslotName}"]`);
        if (selectedGroup) {
            selectedGroup.style.display = 'block';
        }
    }
    
    function drawRoutes() {
        routes.forEach(function(route, index) {
            if (route.stops && route.stops.length > 0) {
                // Create route path from stops
                const routeCoords = route.stops.map(function(stop) {
                    return [stop.latitude, stop.longitude];
                });
                
                // Only draw if we have valid coordinates
                if (routeCoords.length > 1) {
                    const routeLayer = L.polyline(routeCoords, {
                        color: route.vehicle.kleur,
                        weight: 4,
                        opacity: 0.8
                    }).addTo(map);
                    
                    routeLayers.push(routeLayer);
                    
                    // Add direction arrows
                    const decorator = L.polylineDecorator(routeLayer, {
                        patterns: [{
                            offset: '5%',
                            repeat: '10%',
                            symbol: L.Symbol.arrowHead({
                                pixelSize: 8,
                                polygon: false,
                                pathOptions: {
                                    color: route.vehicle.kleur,
                                    fillOpacity: 1,
                                    weight: 2
                                }
                            })
                        }]
                    }).addTo(map);
                }
                
                // Add patient markers with numbers
                route.stops.forEach(function(stop) {
                    if (stop.type !== 'ORIGIN' && stop.type !== 'DESTINATION') {
                        const markerColor = route.vehicle.kleur;
                        
                        // Create numbered marker
                        const label = L.divIcon({
                            className: 'numbered-marker',
                            html: `<div style="background: ${markerColor}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid white;">${stop.sequence || '?'}</div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });
                        
                        const numberedMarker = L.marker([stop.latitude, stop.longitude], {
                            icon: label
                        }).addTo(map);
                        
                        numberedMarker.patientId = stop.id;
                        patientMarkers.push(numberedMarker);
                        
                        numberedMarker.bindPopup(`
                            <strong>${stop.naam}</strong><br>
                            Type: ${stop.type}<br>
                            Sequence: ${stop.sequence}<br>
                            Vehicle: ${route.vehicle.kenteken}
                        `);
                    }
                });
            }
        });
        
        // Fit map to show all routes
        if (routeLayers.length > 0) {
            const group = L.featureGroup(routeLayers);
            map.fitBounds(group.getBounds(), { padding: [20, 20] });
        }
    }
    
    function showTimeslotRoutes(timeslotName) {
        // Update active time segment
        document.querySelectorAll('.time-segment').forEach(segment => {
            segment.classList.remove('active');
        });
        event.target.classList.add('active');
        
        // Hide all timeslot groups
        document.querySelectorAll('.timeslot-group').forEach(group => {
            group.style.display = 'none';
        });
        
        // Show selected timeslot group
        const selectedGroup = document.querySelector(`[data-timeslot="${timeslotName}"]`);
        if (selectedGroup) {
            selectedGroup.style.display = 'block';
        }
        
        // Clear existing layers
        routeLayers.forEach(layer => map.removeLayer(layer));
        routeLayers = [];
        patientMarkers.forEach(marker => map.removeLayer(marker));
        patientMarkers = [];
        
        // Filter routes for selected timeslot
        const timeslotRoutes = routes.filter(route => route.timeslot_name === timeslotName);
        
        // Draw only routes for selected timeslot
        timeslotRoutes.forEach(function(route, index) {
            if (route.stops && route.stops.length > 0) {
                // Create route path from stops
                const routeCoords = route.stops.map(function(stop) {
                    return [stop.latitude, stop.longitude];
                });
                
                // Only draw if we have valid coordinates
                if (routeCoords.length > 1) {
                    const routeLayer = L.polyline(routeCoords, {
                        color: route.vehicle.kleur,
                        weight: 4,
                        opacity: 0.8
                    }).addTo(map);
                    
                    routeLayers.push(routeLayer);
                    
                    // Add direction arrows
                    const decorator = L.polylineDecorator(routeLayer, {
                        patterns: [{
                            offset: '5%',
                            repeat: '10%',
                            symbol: L.Symbol.arrowHead({
                                pixelSize: 8,
                                polygon: false,
                                pathOptions: {
                                    color: route.vehicle.kleur,
                                    fillOpacity: 1,
                                    weight: 2
                                }
                            })
                        }]
                    }).addTo(map);
                }
                
                // Add patient markers with numbers
                route.stops.forEach(function(stop) {
                    if (stop.type !== 'ORIGIN' && stop.type !== 'DESTINATION') {
                        const markerColor = route.vehicle.kleur;
                        
                        // Create numbered marker
                        const label = L.divIcon({
                            className: 'numbered-marker',
                            html: `<div style="background: ${markerColor}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; border: 2px solid white;">${stop.sequence || '?'}</div>`,
                            iconSize: [24, 24],
                            iconAnchor: [12, 12]
                        });
                        
                        const numberedMarker = L.marker([stop.latitude, stop.longitude], {
                            icon: label
                        }).addTo(map);
                        
                        numberedMarker.patientId = stop.id;
                        patientMarkers.push(numberedMarker);
                        
                        numberedMarker.bindPopup(`
                            <strong>${stop.naam}</strong><br>
                            Type: ${stop.type}<br>
                            Sequence: ${stop.sequence}<br>
                            Vehicle: ${route.vehicle.kenteken}
                        `);
                    }
                });
            }
        });
        
        // Fit map to show selected routes
        if (routeLayers.length > 0) {
            const group = L.featureGroup(routeLayers);
            map.fitBounds(group.getBounds(), { padding: [20, 20] });
        }
    }
    
    function fitAllRoutes() {
        // Clear and redraw all routes
        routeLayers.forEach(layer => map.removeLayer(layer));
        routeLayers = [];
        patientMarkers.forEach(marker => map.removeLayer(marker));
        patientMarkers = [];
        
        drawRoutes();
        
        if (routeLayers.length > 0) {
            const group = L.featureGroup(routeLayers);
            map.fitBounds(group.getBounds(), { padding: [20, 20] });
        }
    }
    
    function toggleRouteVisibility() {
        routeLayers.forEach(function(layer) {
            if (map.hasLayer(layer)) {
                map.removeLayer(layer);
            } else {
                map.addLayer(layer);
            }
        });
    }

    // Calculate and display route statistics
    function calculateRouteStatistics() {
        const statsContainer = document.getElementById('route-stats-container');
        const totalStatsCard = document.getElementById('total-stats-card');
        const totalStatsGrid = document.getElementById('total-stats-grid');
        
        let totalDistance = 0;
        let totalTime = 0;
        let totalCost = 0;
        let totalPatients = 0;
        
        statsContainer.innerHTML = '';
        
        routes.forEach(function(route, index) {
            if (route.stops && route.stops.length > 1) {
                // Calculate route distance using Haversine formula
                let routeDistance = 0;
                for (let i = 0; i < route.stops.length - 1; i++) {
                    const lat1 = route.stops[i].latitude;
                    const lon1 = route.stops[i].longitude;
                    const lat2 = route.stops[i + 1].latitude;
                    const lon2 = route.stops[i + 1].longitude;
                    
                    const R = 6371; // Earth's radius in kilometers
                    const dLat = (lat2 - lat1) * Math.PI / 180;
                    const dLon = (lon2 - lon1) * Math.PI / 180;
                    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                             Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                             Math.sin(dLon/2) * Math.sin(dLon/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    routeDistance += R * c;
                }
                
                // Calculate time (assuming 50 km/h average speed)
                const routeTime = (routeDistance / 50) * 60; // minutes
                
                // Calculate cost (‚Ç¨0.50 per km)
                const routeCost = routeDistance * 0.50;
                
                // Count patients (exclude origin/destination)
                const patientCount = route.stops.filter(stop => 
                    stop.type !== 'ORIGIN' && stop.type !== 'DESTINATION'
                ).length;
                
                // Create route stat card
                const statCard = document.createElement('div');
                statCard.className = 'route-stat-card';
                statCard.innerHTML = `
                    <div class="route-stat-vehicle">
                        <i class="fas fa-car"></i>
                        ${route.vehicle.kenteken}
                    </div>
                    <div class="route-stat-grid">
                        <div class="route-stat-item">
                            <div class="route-stat-value">${routeDistance.toFixed(1)}</div>
                            <div class="route-stat-label">km</div>
                        </div>
                        <div class="route-stat-item">
                            <div class="route-stat-value">${Math.round(routeTime)}</div>
                            <div class="route-stat-label">min</div>
                        </div>
                        <div class="route-stat-item">
                            <div class="route-stat-value">‚Ç¨${routeCost.toFixed(2)}</div>
                            <div class="route-stat-label">kosten</div>
                        </div>
                        <div class="route-stat-item">
                            <div class="route-stat-value">${patientCount}</div>
                            <div class="route-stat-label">pati√´nten</div>
                        </div>
                    </div>
                `;
                statsContainer.appendChild(statCard);
                
                // Accumulate totals
                totalDistance += routeDistance;
                totalTime += routeTime;
                totalCost += routeCost;
                totalPatients += patientCount;
            }
        });
        
        // Show total statistics
        if (routes.length > 0) {
            totalStatsCard.style.display = 'block';
            totalStatsGrid.innerHTML = `
                <div class="total-stat-item">
                    <div class="total-stat-value">${routes.length}</div>
                    <div class="total-stat-label">Routes</div>
                </div>
                <div class="total-stat-item">
                    <div class="total-stat-value">${totalPatients}</div>
                    <div class="total-stat-label">Pati√´nten</div>
                </div>
                <div class="total-stat-item">
                    <div class="total-stat-value">${totalDistance.toFixed(1)}</div>
                    <div class="total-stat-label">km Totaal</div>
                </div>
                <div class="total-stat-item">
                    <div class="total-stat-value">${Math.round(totalTime)}</div>
                    <div class="total-stat-label">min Totaal</div>
                </div>
                <div class="total-stat-item">
                    <div class="total-stat-value">‚Ç¨${totalCost.toFixed(2)}</div>
                    <div class="total-stat-label">Kosten Totaal</div>
                </div>
                <div class="total-stat-item">
                    <div class="total-stat-value">‚Ç¨${(totalCost / totalPatients).toFixed(2)}</div>
                    <div class="total-stat-label">Kosten/Pati√´nt</div>
                </div>
            `;
        }
    }
    
    // Calculate statistics when page loads
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(calculateRouteStatistics, 1000); // Wait for map to load
    });
</script>
{% else %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body text-center">
                    <h3>Geen Planning Gevonden</h3>
                    <p>Er is nog geen route planning uitgevoerd. Start een nieuwe planning om routes te genereren.</p>
                    <a href="{% url 'new_planning' %}" class="btn btn-primary">Nieuwe Planning</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
